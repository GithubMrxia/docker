FROM php:7.1-fpm

ENV ZEND_EXTENSION_DIR=/usr/local/lib/php/extensions/no-debug-non-zts-20160303/ \
    REDIS_VERSION=4.1.1 \
    NODE_VERSION=node-v8.12.0-linux-x64
    
RUN apt-get -y update && apt-get install -y \
    vim \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libpng-dev \
    && rm -r /var/lib/apt/lists/*
    
COPY conf/php7.1.ini         /usr/local/etc/php/php.ini
COPY conf/php-fpm.conf    /usr/local/etc/php-fpm.conf
RUN docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \
    && docker-php-ext-install -j$(nproc) zip \
    gd \
    mysqli \
    pdo_mysql \
    bcmath

COPY resources/redis-${REDIS_VERSION}.tgz /home/resources/redis.tgz
ADD resources/${NODE_VERSION}.tar.xz /home/resources
RUN pecl install /home/resources/redis.tgz \
    && docker-php-ext-enable redis \
    && mkdir -p /var/log/php \
    && chown www-data:www-data /var/log/php \
    && cp /home/resources/${NODE_VERSION}/bin/node /usr/local/bin/node \
    && cp -rf /home/resources/${NODE_VERSION}/lib/* /usr/local/lib/ \
    && ln -s  /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm \
    && npm install -g cnpm --registry=https://registry.npm.taobao.org \
    && rm -rf /home/resources

COPY resources/composer.phar /usr/local/bin/composer
RUN chmod 755 /usr/local/bin/composer \
    && useradd -m -G www-data -s /bin/bash mrxia \
    && usermod -G www-data mrxia \
    && chmod -R 777 /var/log/php

USER mrxia
RUN composer config -g repo.packagist composer https://packagist.laravel-china.org
USER root
VOLUME ["/var/wwwroot"]
WORKDIR /var/wwwroot

CMD ["sh", "-c", "php-fpm"]