FROM php:5.6-fpm

ARG XDEBUG_REMOTE_HOST=10.0.75.1
ENV ZEND_EXTENSION_DIR=/usr/local/lib/php/extensions/no-debug-non-zts-20131226/ \
    REDIS_VERSION=3.1.6 \
    XDEBUG_VERSION=2.5.5 \
    MONGO_VERSION=1.4.2 \
    NODE_VERSION=node-v8.10.0-linux-x64
    
COPY resources/sources.list /etc/apt/sources.list
RUN apt-get -y update && apt-get install -y \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libmcrypt-dev \
    libpng-dev \
    libpq-dev \
    vim \
    git \
    && rm -r /var/lib/apt/lists/*
    
COPY conf/php5.6.ini         /usr/local/etc/php/php.ini
COPY conf/php-fpm.conf    /usr/local/etc/php-fpm.conf
RUN docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \
    && docker-php-ext-install -j$(nproc) zip \
    gd \
    mcrypt \
    mysql \
    mysqli \
    pdo \
    pdo_mysql \
    pgsql \
    pdo_pgsql \
    bcmath

COPY resources/redis-${REDIS_VERSION}.tgz /home/resources/redis.tgz
COPY resources/xdebug-${XDEBUG_VERSION}.tgz /home/resources/xdebug.tgz
COPY resources/mongodb-${MONGO_VERSION}.tgz /home/resources/mongo.tgz
ADD resources/${NODE_VERSION}.tar.xz /home/resources
RUN pecl install /home/resources/redis.tgz \
    && docker-php-ext-enable redis \
    && pecl install /home/resources/mongo.tgz \
    && docker-php-ext-enable mongodb \
    && pecl install /home/resources/xdebug.tgz \
    && echo "zend_extension=${ZEND_EXTENSION_DIR}xdebug.so\nxdebug.remote_enable=1\nxdebug.remote_port=9000\nxdebug.remote_autostart=on\nxdebug.remote_host=${XDEBUG_REMOTE_HOST}\nxdebug.remote_log=/var/log/php/xdebug-remote.log" > /usr/local/etc/php/conf.d/xdebug.ini \
    && mkdir -p /var/log/php \
    && chown www-data:www-data /var/log/php \
    && cp /home/resources/${NODE_VERSION}/bin/node /usr/local/bin/node \
    && cp -rf /home/resources/${NODE_VERSION}/lib/* /usr/local/lib/ \
    && ln -s  /usr/local/lib/node_modules/npm/bin/npm-cli.js /usr/local/bin/npm \
    && npm install -g cnpm --registry=https://registry.npm.taobao.org \
    && rm -rf /home/resources

COPY resources/composer.phar /usr/local/bin/composer
RUN chmod 755 /usr/local/bin/composer \
    && useradd -m -G www-data -s /bin/bash company \
    && usermod -G www-data company \
    && touch /var/log/php/xdebug-remote.log \
    && chmod -R 777 /var/log/php

USER company
RUN composer config -g repo.packagist composer https://packagist.phpcomposer.com
USER root
EXPOSE 9000
VOLUME ["/var/wwwroot"]